{% from "components/breadcrumb.html" import breadcrumb with context %}

<div class="grid grid-cols-1 px-4 pt-6 mb-4 xl:grid-cols-3 xl:gap-4 dark:bg-gray-900 dark:border-gray-700">
    <div class="col-span-full mb-4 xl:mb-2">
        {{
        breadcrumb([
        {'label': 'Dashboard'},
        ])
        }}
        <h1 class="text-4xl font-semibold text-gray-900 sm:text-4xl dark:text-white">Dashboard</h1>
    </div>
    <div class="p-4 mb-4 bg-white rounded-lg shadow sm:p-6 xl:p-8 dark:bg-gray-800 xl:mb-0">
        <a href="" class="flex items-center mb-6 text-2xl   dark:text-gray-400">
            <span class=""> Sensor PM 2.5 </span>
        </a>

        <p class=" font-bold text-4xl  text-green-400" id="pm25_state">
            Loading...
        </p>
        <div class="text-sm mt-6 space-y-4 sm:space-y-0 dark:text-white sm:space-x-3">
            Monitoring Real-Time Sensor PM 2.5 <br>
            Update Data Terakhir:<span class="font-bold" id="pm25_state_time">     Loading...</span>
        </div>
    </div>
    <div class="p-4 mb-4 bg-white rounded-lg shadow sm:p-6 xl:p-8 dark:bg-gray-800 xl:mb-0">
        <a href="" class="flex items-center mb-6 text-2xl  dark:text-gray-400">
            <span>Sensor RCWL </span>
        </a>
        <p class=" font-bold text-4xl  text-green-400" id="rcwl_state">
            Loading...
        </p>
        <div class="text-sm mt-6 space-y-4 sm:space-y-0 dark:text-white sm:space-x-3">
            Monitoring Real-Time Sensor RCWL <br>
            Update Data Terakhir:<span class="font-bold" id="rcwl_state_time">     Loading...</span>
        </div>
    </div>
    <div class="p-4 mb-4 bg-white rounded-lg shadow sm:p-6 xl:p-8 dark:bg-gray-800 xl:mb-0">
        <a href="" class="flex items-center mb-6 text-2xl  dark:text-gray-400">
            State Pengunci
        </a>
        <p class=" font-bold text-4xl text-green-400" id="lock_state">
            Loading...
        </p>
        <p class="text-sm font-semibold text-gray-900 dark:text-gray-400">

        </p>
        <div class="text-sm mt-6 space-y-4 sm:space-y-0 dark:text-white sm:space-x-3">
            <div>
                <button id="toggle-lock-state"
                        class="  text-white focus:ring-4  font-medium inline-flex w-full sm:w-auto
                    rounded-lg text-sm px-5 py-2.5  focus:ring-red-300 bg-red-700 hover:bg-red-800  dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">
                    <svg class="w-4 h-4 m-auto mr-2 text-gray-800 text-white" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" width="16" height="24" fill="currentColor"
                         viewBox="0 0 24 24">
                        <path fill-rule="evenodd"
                              d="M8 10V7a4 4 0 1 1 8 0v3h1a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h1Zm2-3a2 2 0 1 1 4 0v3h-4V7Zm2 6a1 1 0 0 1 1 1v3a1 1 0 1 1-2 0v-3a1 1 0 0 1 1-1Z"
                              clip-rule="evenodd"/>
                    </svg>

                    Ganti State
                </button>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 px-4 pt-6 mb-4 xl:grid-cols-1 xl:gap-4 dark:bg-gray-900 dark:border-gray-700">
    <div class="p-4 mb-4 bg-white rounded-lg shadow sm:p-6 xl:p-8 dark:bg-gray-800 xl:mb-0">
        <a href="" class="flex items-center mb-6 text-2xl   dark:text-gray-400">
            <span class=""> Frame (CCTV) </span>
        </a>
        <p class="mb-2 text-base font-normal text-gray-500 dark:text-gray-400">
        <div id="realtime" class="w-full h-auto rounded-lg">
            <img src="{{ url_for('video_feed') }}" alt="Frame Image" class="w-full h-auto rounded-lg">
        </div>
        </p>
        <p class="text-sm font-semibold text-gray-900 dark:text-gray-400">
        </p>
        <div class="mt-6 space-y-4 sm:flex sm:space-y-0 sm:space-x-3">

        </div>
    </div>
    <div class="p-4 mb-4 bg-white rounded-lg shadow sm:p-6 xl:p-8 dark:bg-gray-800 xl:mb-0">
        <a href="" class="flex items-center mb-6 text-2xl   dark:text-gray-400">
            <span class=""> Table View : Alert </span>
        </a>
        <p class="mb-2 text-base font-normal text-gray-500 dark:text-gray-400">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
                <th scope="col"
                    class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                    No
                </th>
                <th scope="col"
                    class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                    Timestamp
                </th>
                <th scope="col"
                    class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white">
                    Status Alert
                </th>
            </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800">
            <tr>
                <td class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white">
                    1
                </td>
                <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400">
                    Apr 23 ,2021
                </td>

                <td class="p-4 whitespace-nowrap">
                      <span
                              class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-md dark:bg-gray-700 dark:text-red-400 border border-red-100 dark:border-red-500">Danger</span>
                </td>
            </tr>

            </tbody>
        </table>
        </p>
        <p class="text-sm font-semibold text-gray-900 dark:text-gray-400">
        </p>
        <div class="mt-6 space-y-4 sm:flex sm:space-y-0 sm:space-x-3">

        </div>
    </div>
<!--    <div class="p-4 mb-4 bg-white rounded-lg shadow sm:p-6 xl:p-8 dark:bg-gray-800 xl:mb-0">-->
<!--        <a href="" class="flex items-center mb-6 text-2xl   dark:text-gray-400">-->
<!--            <span class=""> Logging Activity Sistem </span>-->
<!--        </a>-->
<!--        <p class="mb-2 text-base font-normal text-gray-500 dark:text-gray-400">-->

<!--        <ol class="relative border-s border-gray-200 dark:border-gray-700">-->
<!--            <li class="mb-10 ms-4">-->
<!--                <div class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"></div>-->
<!--                <time class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">February 2022-->
<!--                </time>-->
<!--                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ada Perubahan Jadwal</h3>-->

<!--            </li>-->
<!--            <li class="mb-10 ms-4">-->
<!--                <div class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"></div>-->
<!--                <time class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">March 2022</time>-->
<!--                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ada Perubahan Jadwal</h3>-->

<!--            </li>-->
<!--            <li class="ms-4">-->
<!--                <div class="absolute w-3 h-3 bg-gray-200 rounded-full mt-1.5 -start-1.5 border border-white dark:border-gray-900 dark:bg-gray-700"></div>-->
<!--                <time class="mb-1 text-sm font-normal leading-none text-gray-400 dark:text-gray-500">April 2022</time>-->
<!--                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ada Perubahan Jadwal</h3>-->

<!--            </li>-->
<!--        </ol>-->


<!--        </p>-->
<!--        <p class="text-sm font-semibold text-gray-900 dark:text-gray-400">-->
<!--        </p>-->
<!--        <div class="mt-6 space-y-4 sm:flex sm:space-y-0 sm:space-x-3">-->

<!--        </div>-->
<!--    </div>-->
</div>



<script>
    function fetchSensorData() {
        $.ajax({
            url: '/sensor_data',
            method: 'GET',
            success: function (data) {
                updateSensorCards(data);
            },
            error: function (error) {
                console.error('Error fetching sensor data:', error);
            }
        });
    }

    function updateSensorCards(data) {
        data.forEach(sensor => {
            const sensorId = sensor['name'];
            let sensorValue, sensorValueClass;

            switch (sensorId) {
                case 'pm25_state':
                    sensorValue = sensor['value'] === '1' ? 'Smoke Detected' : 'No Smoke';
                    sensorValueClass = sensor['value'] === '1' ? 'text-green-400' : 'text-red-400';
                    break;
                case 'rcwl_state':
                    sensorValue = sensor['value'] === '1' ? 'Motion Detected' : 'No Motion';
                    sensorValueClass = sensor['value'] === '1' ? 'text-green-400' : 'text-red-400';
                    break;
                case 'lock_state':
                    sensorValue = sensor['value'] === '1' ? 'ON' : 'OFF';
                    sensorValueClass = sensor['value'] === '1' ? 'text-green-400' : 'text-red-400';
                    updateLockStateButton(sensor['value']);
                    break;
            }
            const formattedTime = new Date(sensor['created_at']).toLocaleString();
            $('#' + sensorId).text(sensorValue).attr('class', 'font-bold text-4xl ' + sensorValueClass);
            $('#' + sensorId + '_time').text( formattedTime);
        });
    }

    function updateLockStateButton(value) {
        const button = $('#toggle-lock-state');
        if (value === '1') {
            button.removeClass('bg-red-700 hover:bg-red-800 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800')
                .addClass('bg-green-700 hover:bg-green-800 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800')
                .text('OFF');
        } else {

            button.removeClass('bg-green-700 hover:bg-green-800 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800')
                .addClass('bg-red-700 hover:bg-red-800 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800')
                .text('ON');

        }
    }

    function toggleLockState() {
        $.ajax({
            url: '/toggle_lock_state',
            method: 'POST',
            success: function (data) {
                fetchSensorData(); // Refresh sensor data after toggling the lock state
            },
            error: function (error) {
                console.error('Error toggling lock state:', error);
            }
        });
    }

    $(document).ready(function () {
        $('#toggle-lock-state').click(toggleLockState);

        // Fetch sensor data every second
        setInterval(fetchSensorData, 1000);

        // Initial fetch
        fetchSensorData();
    });
</script>
